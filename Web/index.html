<!DOCTYPE html>
<html>
<head>
	<title>Kommunalvalg 2013</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="main.css" />

	<script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJApA5cYCBclbRC2zvqw3woNmjedbxoY4"></script>
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script src="data.js"></script>
</head>

<body>
    <div id="container">
        <div id="map-canvas"></div>
        <div id="main-controls">

            <div class="tab-content">
                <div id="location-overlay-display" class="tab-pane overlay-controls active">
                    <div id="location-overlay-hint">
                        <h4>Klik på et valgsted for at hente data</h4>
                    </div>
                    <div id="location-overlay-data" style="display: none">
                        <div id="location-overlay-infobox">
                            <h3 id="municipality-name"></h3>
                            <h4 id="location-name"></h4>
                            <hr />

                            <p>
                                <h4>Valgdeltagelse</h4>
                                <small><b><span id="voting-percentage" style="width: 36px;">0%</span></b> af <b><span id="eligible-voters">0</span></b> stemmeberettigede</small>
                            </p>

                            <div>
                                <span class="progress" style="width: 100%;">
                                    <span id="counted-votes" class="progress-bar progress-bar-success" role="progressbar" style="width: 30%"></span>
                                    <span id="missing-votes" class="progress-bar progress-bar-warning" role="progressbar" style="width: 30%"></span>
                                </span>
                            </div>

                        </div>
                        <table id="candidate-table" class="table">
                            <thead id="candidate-header">
                                <tr>
                                    <td style="width: 30px;"></td>
                                    <td><strong>Navn</strong></td>
                                    <td><strong>Stemmer</strong></td>
                                    <td><strong>Andel</strong></td>
                                </tr>
                            </thead>
                            <tbody id="candidate-list">
                                <!--- Data goes here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="municipality-overlay-display" class="tab-pane overlay-controls">
                    <div id="municipality-overlay-hint">

                    </div>

                    <div id="municipality-overlay-data">

                    </div>
                </div>
            </div>
        </div>
    </div>

	<script type="text/javascript">
      
        var municipal_data = [
            geometry_municipalities,
            electiondata_municipalities
        ];

        var location_data = [
            geometry_locations,
            electiondata_locations
        ]

        var dataSource = municipal_data;

        function main() {
            // Rough bounds of Denmark
		    var bounds = new google.maps.LatLngBounds(
			    new google.maps.LatLng(54.534223, 7.816973),
			    new google.maps.LatLng(57.882655, 15.479440)
		    )
		
		    var map = new google.maps.Map(document.getElementById('map-canvas'), {
			    zoom: 7,
			    mapTypeId: google.maps.MapTypeId.ROADMAP,
			    center: bounds.getCenter()
            });

            var locationOverlay = new google.maps.OverlayView();

            var groups = [];
            dataSource[0].forEach(function (region) {
                var group = {}
                group.shapes = []
                group.name = region[0];

                region[1].forEach(function (subregion) {
                    var polyPoints = [];
                    subregion.forEach(function (point) {
                        polyPoints.push(point);
                    })
                    group.shapes.push(polyPoints);
                })

                groups.push(group);
            });

            locationOverlay.onAdd = function () {
                var layer = d3.select(this.getPanes().overlayMouseTarget).append("div").attr("class", "svg-overlay");
                var svg = layer.append("svg");
                var svgoverlay = svg.append("g");

                svgoverlay.attr("transform", "translate(4000, 4000)");

                locationOverlay.draw = function () {

                    var markerOverlay = this;
                    var overlayProjection = markerOverlay.getProjection();

                    var googleMapProjection = function (coordinates) {
                        var googleCoordinates = new google.maps.LatLng(coordinates[0], coordinates[1]);
                        var pixelCoordinates = overlayProjection.fromLatLngToDivPixel(googleCoordinates);
                        return [pixelCoordinates.x, pixelCoordinates.y];
                    }

                    var nested = svgoverlay
                        .selectAll("g")
                        .data(groups)

                    nested.enter()
                        .append('g')

                    var regions = nested.selectAll("polygon")
                        .data(d => d.shapes)
                            .attr("points", function (d) {
                                return d.map(function (p) {
                                    return googleMapProjection(p).join(",");
                                }).join(" ")
                            })
                            .enter()
                            .append("polygon")
                            .attr("points", function (d) {
                                return d.map(function (p) {
                                    return googleMapProjection(p).join(",");
                                }).join(" ")
                        });

                    nested
                        .on("click", function (d, i) { selectLocation(d.name); })
                        .enter()
                        .append('g')
                };

            };

            locationOverlay.setMap(map);
        };

        main();

        function selectLocation(i) {
            console.log("Selected location " + i);
            $("#location-overlay-hint").hide();
            $("#location-overlay-data").show();

            data = dataSource[1][i];

            $("#municipality-name").text(data[0]);
            $("#location-name").text(data[1]);

            $("#candidate-list tr").remove();

            var pct = Math.round(data[2][1] / data[2][0] * 100);
            $("#counted-votes")
                .text(data[2][1])
                .width(pct + "%");

            $("#missing-votes")
                .text(data[2][0] - data[2][1])
                .width((100 - pct) + "%");

            $("#voting-percentage").text(pct + "%");
            $("#eligible-voters").text(data[2][0]);

            data[3].forEach(function (candidate) {
                var row = document.createElement("tr")

                var letter = document.createElement("td");
                letter.appendChild(document.createTextNode(candidate[0]));
                letter.className += (" party-letter-" + candidate[0]);
                letter.className += (" party-letter");

                var name = document.createElement("td");
                name.appendChild(document.createTextNode(candidate[1]));

                var votes = document.createElement("td");
                votes.appendChild(document.createTextNode(candidate[2]));

                var voteshare = document.createElement("td");
                voteshare.appendChild(document.createTextNode(candidate[3] + "%"));

                row.appendChild(letter);
                row.appendChild(name);
                row.appendChild(votes);
                row.appendChild(voteshare);

                $("#candidate-list").append(row);
            })
        }
	</script>
</body>
</html>